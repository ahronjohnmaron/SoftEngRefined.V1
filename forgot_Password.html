<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forgot Password | Communication Hub</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="susi.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'wise-green': '#9FE870',
            'wise-green-hover': '#7acc50',
            'wise-forest': '#163300',
            'wise-dark': '#0f0f0f',
            'wise-black': '#000000',
            'wise-gray': '#1a1a1a',
            'wise-light-gray': '#b8d6a0',
            'wise-border': '#2d5514',
            'wise-light-bg': '#f5faf2',
            'wise-light-secondary': '#e8f5e0',
            'wise-light-border': '#c9e5ba',
          }
        }
      }
    }
  </script>
  <style>
    body { 
      font-family: 'Inter', sans-serif;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Light mode styles */
    body:not(.dark) {
      background-color: #f5faf2;
    }

    body:not(.dark) .container {
      background-color: #ffffff;
      border-color: #c9e5ba;
    }

    body:not(.dark) input {
      background-color: #e8f5e0;
      border-color: #c9e5ba;
      color: #163300;
    }

    body:not(.dark) input::placeholder {
      color: #2d5514;
      opacity: 0.6;
    }

    body:not(.dark) input:focus {
      background-color: #ffffff;
      border-color: #7acc50;
    }

    body:not(.dark) .text-subtitle {
      color: #2d5514;
    }

    body:not(.dark) .modal-bg {
      background-color: rgba(0, 0, 0, 0.6);
    }

    body:not(.dark) .modal-content {
      background-color: #ffffff;
      border: 1px solid #c9e5ba;
    }

    /* Password requirement styles */
    .password-requirement .fa-check-circle { display: none; }
    .password-requirement .fa-times-circle { display: inline-block; }
    body:not(.dark) .password-requirement .fa-times-circle { color: #ef4444; }
    body.dark .password-requirement .fa-times-circle { color: #ef4444; opacity: 0.7; }
    
    .password-requirement.met { color: #9FE870; } /* wise-green */
    body:not(.dark) .password-requirement.met { color: #2d5514; }

    .password-requirement.met .fa-check-circle { display: inline-block; }
    .password-requirement.met .fa-times-circle { display: none; }

    /* Strength bar colors */
    .password-strength-fill { transition: width 0.3s ease, background-color 0.3s ease; }
    .password-strength-fill.weak { width: 33%; background-color: #ef4444; } /* red-500 */
    .password-strength-fill.medium { width: 66%; background-color: #f59e0b; } /* yellow-500 */
    .password-strength-fill.strong { width: 100%; background-color: #9FE870; } /* wise-green */
  </style>
</head>
<body class="dark bg-wise-black flex items-center justify-center min-h-screen p-4">

  <div class="container bg-wise-dark p-8 rounded-2xl shadow-2xl w-full max-w-md border border-wise-border">
    
    <div class="flex justify-end mb-4">
      <button id="themeToggle" class="bg-wise-gray text-wise-light-gray px-3 py-2 rounded-xl border border-wise-border hover:bg-wise-border hover:text-white hover:border-wise-green transition-all duration-300 text-sm font-semibold">
        <i class="fas fa-moon" id="themeIcon"></i>
      </button>
    </div>

    <div class="text-center mb-6">
      <div class="mx-auto w-20 h-20 mb-4">
        <img src="CCSICTLOGOCROP.png" alt="Logo" class="w-full h-full rounded-full border-4 border-wise-green shadow-lg shadow-wise-green/50">
      </div>
      <h2 class="text-2xl sm:text-3xl font-bold text-wise-green mb-2">Forgot Password</h2>
      <p class="text-subtitle text-wise-light-gray text-sm">Enter your registered email address</p>
    </div>

    <form id="emailForm" class="space-y-4">
      <input type="email" id="emailInput" required placeholder="Email Address"
             class="w-full bg-wise-gray text-white px-4 py-3 rounded-xl border-2 border-wise-border focus:outline-none focus:border-wise-green focus:ring-4 focus:ring-wise-green/30 transition-all">
      <button type="submit" id="sendOtpBtn"
              class="w-full bg-gradient-to-r from-wise-green to-wise-green-hover hover:shadow-lg hover:shadow-wise-green/30 font-bold text-black py-3 rounded-xl transition-all transform hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed">
              Send OTP Code
      </button>
    </form>

    <p id="emailMessage" class="text-sm text-center mt-4 min-h-[24px]"></p>

    <div id="otpModal" class="modal-bg hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
      <div class="modal-content bg-wise-gray p-6 sm:p-8 rounded-2xl w-full max-w-sm text-center shadow-2xl shadow-wise-green/30 border border-wise-green">
        <h3 class="text-xl sm:text-2xl font-bold text-wise-green mb-2">Verify OTP</h3>
        <p class="text-wise-light-gray text-sm mb-4">Enter the 6-digit code sent to your email</p>
        <input type="text" id="otpCode" maxlength="6" placeholder="000000"
               class="w-full px-4 py-3 mb-4 bg-wise-black text-white text-center text-2xl tracking-widest border-2 border-wise-border rounded-xl focus:outline-none focus:border-wise-green focus:ring-4 focus:ring-wise-green/30 transition-all">
        <button id="verifyOtpBtn"
                class="w-full bg-gradient-to-r from-wise-green to-wise-green-hover hover:shadow-lg hover:shadow-wise-green/30 font-bold text-black py-3 rounded-xl transition-all transform hover:-translate-y-1">
                Verify Code
        </button>
        <p id="otpMessage" class="text-sm mt-3 min-h-[20px]"></p>
      </div>
    </div>

    <form id="resetForm" class="hidden mt-6 space-y-4">
      <div class="relative">
        <input type="password" id="newPassword" required placeholder="Enter New Password"
               class="w-full bg-wise-gray text-white px-4 py-3 rounded-xl border-2 border-wise-border focus:outline-none focus:border-wise-green focus:ring-4 focus:ring-wise-green/30 transition-all pr-12">
        <button type="button" id="toggleNewPassword" class="absolute right-4 top-1/2 -translate-y-1/2 text-wise-light-gray hover:text-wise-green transition-colors duration-300">
          <i class="fas fa-eye-slash" id="toggleIcon"></i>
        </button>
      </div>
      
      <div class="text-left text-xs space-y-1">
        <div id="passwordStrength" class="h-2 w-full bg-wise-gray rounded-full overflow-hidden border border-wise-border">
          <div id="strengthBar" class="password-strength-fill h-full rounded-full"></div>
        </div>
        <ul class="pt-2 grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1">
          <li id="req-length" class="password-requirement text-wise-light-gray">
            <i class="fas fa-times-circle"></i><i class="fas fa-check-circle"></i>
            <span class="ml-1">8 characters minimum</span>
          </li>
          <li id="req-uppercase" class="password-requirement text-wise-light-gray">
            <i class="fas fa-times-circle"></i><i class="fas fa-check-circle"></i>
            <span class="ml-1">1 uppercase letter</span>
          </li>
          <li id="req-lowercase" class="password-requirement text-wise-light-gray">
            <i class="fas fa-times-circle"></i><i class="fas fa-check-circle"></i>
            <span class="ml-1">1 lowercase letter</span>
          </li>
          <li id="req-number" class="password-requirement text-wise-light-gray">
            <i class="fas fa-times-circle"></i><i class="fas fa-check-circle"></i>
            <span class="ml-1">1 number</span>
          </li>
          <li id="req-special" class="password-requirement text-wise-light-gray">
            <i class="fas fa-times-circle"></i><i class="fas fa-check-circle"></i>
            <span class="ml-1">1 special character</span>
          </li>
        </ul>
      </div>

      <button type="submit" id="updatePasswordBtn"
              class="w-full bg-gradient-to-r from-wise-green to-wise-green-hover hover:shadow-lg hover:shadow-wise-green/30 font-bold text-black py-3 rounded-xl transition-all transform hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed">
              Update Password
      </button>
      <p id="resetMessage" class="text-sm text-center mt-4 min-h-[24px]"></p>
    </form>

    <div class="mt-6">
      <a href="index.html" class="inline-flex items-center gap-2 text-sm text-wise-light-gray hover:text-wise-green transition-colors duration-300">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Login
      </a>
    </div>

  </div>

<script>
  // ============================================
  // THEME TOGGLE FUNCTIONALITY (Unchanged)
  // ============================================
  function initTheme() {
    const savedTheme = localStorage.getItem('forgotPasswordTheme') || 'dark';
    const body = document.body;
    const themeIcon = document.getElementById('themeIcon');
    
    if (savedTheme === 'light') {
      body.classList.remove('dark');
      themeIcon.classList.remove('fa-moon');
      themeIcon.classList.add('fa-sun');
    } else {
      body.classList.add('dark');
      themeIcon.classList.remove('fa-sun');
      themeIcon.classList.add('fa-moon');
    }
  }

  function toggleTheme() {
    const body = document.body;
    const themeIcon = document.getElementById('themeIcon');
    
    body.classList.toggle('dark');
    
    if (body.classList.contains('dark')) {
      themeIcon.classList.remove('fa-sun');
      themeIcon.classList.add('fa-moon');
      localStorage.setItem('forgotPasswordTheme', 'dark');
    } else {
      themeIcon.classList.remove('fa-moon');
      themeIcon.classList.add('fa-sun');
      localStorage.setItem('forgotPasswordTheme', 'light');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    initTheme();
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
  });
  
  // Initialize EmailJS
  (function() {
    emailjs.init('tbAldsuV0ZauR0pr0');
  })();

  // --- Form Elements ---
  const emailForm = document.getElementById('emailForm');
  const otpModal = document.getElementById('otpModal');
  const resetForm = document.getElementById('resetForm');
  const emailInput = document.getElementById('emailInput');
  const otpCode = document.getElementById('otpCode');
  const newPasswordInput = document.getElementById('newPassword');
  const emailMessage = document.getElementById('emailMessage');
  const otpMessage = document.getElementById('otpMessage');
  const resetMessage = document.getElementById('resetMessage');
  const sendOtpBtn = document.getElementById('sendOtpBtn');
  const updatePasswordBtn = document.getElementById('updatePasswordBtn');

  // --- ADDED: Password UI Elements ---
  const strengthBar = document.getElementById('strengthBar');
  const toggleNewPassword = document.getElementById('toggleNewPassword');
  const toggleIcon = document.getElementById('toggleIcon');

  let currentEmail = '';
  let generatedOtp = '';

  // ============================================
  // ADDED: PASSWORD VALIDATION LOGIC
  // (Copied from your basis script)
  // ============================================
  const passwordRequirements = {
    length: /.{8,}/,
    uppercase: /[A-Z]/,
    lowercase: /[a-z]/,
    number: /[0-9]/,
    special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/
  };

  function isPasswordStrong(password) {
    return Object.values(passwordRequirements).every(regex => regex.test(password));
  }

  // Live password validation listener
  newPasswordInput.addEventListener('input', function() {
    const password = this.value;
    let metCount = 0;

    // Check each requirement
    for (const [key, regex] of Object.entries(passwordRequirements)) {
      const element = document.getElementById(`req-${key}`);
      if (regex.test(password)) {
        element.classList.add('met');
        metCount++;
      } else {
        element.classList.remove('met');
      }
    }

    // Update strength bar
    strengthBar.className = 'password-strength-fill h-full rounded-full'; // Reset classes
    if (metCount === 5) {
      strengthBar.classList.add('strong');
    } else if (metCount >= 3) {
      strengthBar.classList.add('medium');
    } else if (metCount > 0) {
      strengthBar.classList.add('weak');
    }
  });
  
  // Password toggle (show/hide) listener
  toggleNewPassword.addEventListener('click', () => {
    if (newPasswordInput.type === 'password') {
      newPasswordInput.type = 'text';
      toggleIcon.classList.remove('fa-eye-slash');
      toggleIcon.classList.add('fa-eye');
    } else {
      newPasswordInput.type = 'password';
      toggleIcon.classList.remove('fa-eye');
      toggleIcon.classList.add('fa-eye-slash');
    }
  });

  // ============================================
  // STEP 1: Check email and send OTP (Unchanged)
  // ============================================
  emailForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    currentEmail = emailInput.value.trim();
    emailMessage.textContent = 'Checking email...';
    emailMessage.classList.remove('text-red-500', 'text-green-500');
    emailMessage.classList.add('text-wise-light-gray');
    sendOtpBtn.disabled = true;

    try {
      const { data: userData, error } = await supabaseClient
        .from('members')
        .select('email')
        .eq('email', currentEmail)
        .maybeSingle();

      if (error) {
        console.error('Supabase error:', error);
        emailMessage.textContent = '✗ Error checking email. Please try again.';
        emailMessage.classList.add('text-red-500');
        sendOtpBtn.disabled = false;
        return;
      }

      if (!userData) {
        emailMessage.textContent = '✗ No account found with this email address.';
        emailMessage.classList.add('text-red-500');
        sendOtpBtn.disabled = false;
        return;
      }

      generatedOtp = String(Math.floor(100000 + Math.random() * 900000));
      emailMessage.textContent = 'Sending OTP to your email...';

      const templateParams = {
        to_email: currentEmail,
        otp_code: generatedOtp,
        reply_to: currentEmail
      };
      
      await emailjs.send('service_zlsxlxc', 'template_n48tvic', templateParams);

      emailMessage.textContent = '✓ OTP sent successfully! Check your email.';
      emailMessage.classList.remove('text-red-500');
      emailMessage.classList.add('text-green-500');
      
      otpModal.classList.remove('hidden');
    } catch (error) {
      console.error('Full error details:', error);
      emailMessage.textContent = '✗ Failed to send OTP. Please check console.';
      emailMessage.classList.add('text-red-500');
    } finally {
      sendOtpBtn.disabled = false;
    }
  });

  // ============================================
  // STEP 2: Verify OTP (Unchanged)
  // ============================================
  document.getElementById('verifyOtpBtn').addEventListener('click', () => {
    const enteredOtp = otpCode.value.trim();
    otpMessage.textContent = 'Verifying...';
    otpMessage.classList.remove('text-red-500', 'text-green-500');
    otpMessage.classList.add('text-wise-light-gray');

    if (enteredOtp === generatedOtp) {
      otpMessage.textContent = '✓ OTP verified successfully!';
      otpMessage.classList.add('text-green-500');
      
      setTimeout(() => {
        otpModal.classList.add('hidden');
        resetForm.classList.remove('hidden');
        emailForm.classList.add('hidden');
        // Focus the new password field
        newPasswordInput.focus();
      }, 1000);
    } else {
      otpMessage.textContent = '✗ Invalid OTP code. Please try again.';
      otpMessage.classList.add('text-red-500');
      otpCode.value = '';
      otpCode.focus();
    }
  });

  // ============================================
  // MODIFIED: STEP 3: Update password
  // ============================================
  resetForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const newPassword = newPasswordInput.value.trim();
    resetMessage.textContent = '';
    resetMessage.classList.remove('text-red-500', 'text-green-500');
    
    // --- ADDED VALIDATION CHECK ---
    if (!isPasswordStrong(newPassword)) {
      resetMessage.textContent = '✗ Password does not meet all security requirements.';
      resetMessage.classList.add('text-red-500');
      newPasswordInput.focus();
      return;
    }
    // --- END OF ADDED CHECK ---
    
    resetMessage.textContent = 'Updating password...';
    resetMessage.classList.add('text-wise-light-gray');
    updatePasswordBtn.disabled = true;

    try {
      const { error } = await supabaseClient
        .from('members')
        .update({ password: newPassword })
        .eq('email', currentEmail);

      if (error) {
        resetMessage.textContent = '✗ Failed to update password. Please try again.';
        resetMessage.classList.add('text-red-500');
        updatePasswordBtn.disabled = false;
        return;
      }

      resetMessage.textContent = '✓ Password updated successfully! Redirecting to login...';
      resetMessage.classList.add('text-green-500');
      
      setTimeout(() => {
        // Redirect to login page after successful reset
        window.location.href = 'faculty_login.html'; 
      }, 2000);

    } catch (error) {
      resetMessage.textContent = '✗ An error occurred. Please try again.';
      resetMessage.classList.add('text-red-500');
      console.error('Error:', error);
      updatePasswordBtn.disabled = false;
    }
  });

  // Allow only numbers in OTP input (Unchanged)
  otpCode.addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
  });
</script>
</body>
</html>

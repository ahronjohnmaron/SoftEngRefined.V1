<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Announcement</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <style>
        body { 
          font-family: 'Poppins', sans-serif;
          background-color: #1a1a1a;
        }
        .card-shadow {
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        .input-shadow {
          box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        /* Fix cropper.js modal transparency - make it very light */
        .cropper-modal {
          background-color: rgba(0, 0, 0, 0.2) !important;
        }
        .cropper-crop-box {
          border: 3px solid #7ed321 !important;
          box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.2) !important;
        }
        .cropper-view-box {
          outline: 3px solid #7ed321 !important;
        }
        .crop-modal {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(26, 26, 26, 0.95);
          display: none;
          align-items: center;
          justify-content: center;
          z-index: 9999;
        }
        .crop-modal-content {
          background: #2d2d2d;
          border-radius: 8px;
          padding: 30px;
          max-width: 90vw;
          max-height: 90vh;
          overflow: auto;
        }
    </style>
</head>
<body class="text-white min-h-screen p-6">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-3xl font-bold text-center mb-8" style="color: #7ed321;">Upload Announcement</h1>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Left Column: Image Upload & Text Preview -->
      <div class="space-y-6">
        <div class="rounded-lg p-6 card-shadow" style="background-color: #2d2d2d;">
          <label for="imageInput" class="block font-semibold mb-3 text-lg" style="color: #7ed321;">Upload Image</label>
          <input type="file" id="imageInput" accept="image/*" class="mb-4 w-full text-sm rounded border px-3 py-2 text-white input-shadow" style="background-color: #1a1a1a; border-color: #3d3d3d;">
          
          <div class="flex gap-3">
            <button id="extractText" class="flex-1 px-4 py-3 rounded font-bold disabled:opacity-50 transition-all hover:opacity-90" style="background-color: #7ed321; color: #1a1a1a; box-shadow: 0 4px 12px rgba(126, 211, 33, 0.3);" disabled>Extract Text</button>
          </div>
          
          <div id="progressContainer" class="mt-4 hidden">
            <div class="h-3 rounded-full overflow-hidden mb-2" style="background-color: #3d3d3d; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);">
              <div class="h-3 w-0 transition-all" id="progressBar" style="background-color: #7ed321;"></div>
            </div>
            <div class="font-semibold text-sm text-center" id="progressText" aria-live="polite" style="color: #7ed321;">Starting OCR...</div>
          </div>
        </div>
        
        <div class="rounded-lg p-6 card-shadow" style="background-color: #2d2d2d; min-height: 600px;">
          <div class="font-bold mb-3 text-xl" style="color: #7ed321;">Extracted Text Preview</div>
          <pre id="extractedTextPreview" class="rounded p-4 break-all text-base input-shadow overflow-auto" style="background-color: #1a1a1a; color: #a0a0a0; min-height: 520px;">No text extracted yet</pre>
        </div>
      </div>
      
      <!-- Right Column: Form Fields -->
      <div>
        <form class="rounded-lg p-8 space-y-6 card-shadow" style="background-color: #2d2d2d; min-height: 800px;">
          <div class="text-2xl font-bold mb-6" style="color: #7ed321;">Event Details (4 W's)</div>
          
          <div class="grid grid-cols-1 gap-4">
            <div>
              <label class="block mb-2 font-semibold text-base" for="fieldTitle" style="color: #7ed321;">Title</label>
              <input id="fieldTitle" class="w-full rounded px-4 py-3 text-white text-base input-shadow" style="background-color: #1a1a1a; border: 1px solid #3d3d3d;" autocomplete="off" placeholder="Announcement or event title" />
            </div>
            
            <div>
              <label class="block mb-2 font-semibold text-base" for="fieldWhat" style="color: #7ed321;">What (event/content)</label>
              <textarea id="fieldWhat" class="w-full rounded px-4 py-3 text-white text-base input-shadow" style="background-color: #1a1a1a; border: 1px solid #3d3d3d; height: 180px; resize: vertical;" placeholder="Description of the event or announcement"></textarea>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block mb-2 font-semibold text-base" for="fieldWhen" style="color: #7ed321;">When (date/time)</label>
                <input id="fieldWhen" class="w-full rounded px-4 py-3 text-white text-base input-shadow" style="background-color: #1a1a1a; border: 1px solid #3d3d3d;" autocomplete="off" placeholder="Event date and time" />
              </div>
              
              <div>
                <label class="block mb-2 font-semibold text-base" for="fieldWhere" style="color: #7ed321;">Where (location)</label>
                <input id="fieldWhere" class="w-full rounded px-4 py-3 text-white text-base input-shadow" style="background-color: #1a1a1a; border: 1px solid #3d3d3d;" autocomplete="off" placeholder="Event location or venue" />
              </div>
            </div>
            
            <div>
              <label class="block mb-2 font-semibold text-base" for="fieldWhy" style="color: #7ed321;">Why (purpose/reason)</label>
              <textarea id="fieldWhy" class="w-full rounded px-4 py-3 text-white text-base input-shadow" style="background-color: #1a1a1a; border: 1px solid #3d3d3d; height: 150px; resize: vertical;" placeholder="Purpose or reason for the event"></textarea>
            </div>
            
            <div>
              <label class="block mb-2 font-semibold text-base" for="fieldDatePosted" style="color: #7ed321;">Date Posted</label>
              <input id="fieldDatePosted" class="w-full rounded px-4 py-3 text-white text-base input-shadow" style="background-color: #1a1a1a; border: 1px solid #3d3d3d;" autocomplete="off" placeholder="When this was posted" />
            </div>
          </div>
          
          <div id="statusMsg" class="text-base mt-6 font-semibold text-center p-4 rounded hidden" style="color: #7ed321; background-color: rgba(126, 211, 33, 0.1);"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Crop Modal -->
  <div id="cropModal" class="crop-modal">
    <div class="crop-modal-content card-shadow">
      <h2 class="text-2xl font-bold mb-4" style="color: #7ed321;">Crop Your Image</h2>
      <div class="mb-4">
        <img id="cropImage" class="rounded w-full mx-auto" style="border: 2px solid #7ed321; max-height: 70vh;" />
      </div>
      <div class="flex gap-3 justify-end">
        <button id="cancelCropBtn" class="px-6 py-3 rounded font-semibold transition-all hover:opacity-90" style="background-color: #3d3d3d; color: #ffffff;">Cancel</button>
        <button id="cropBtn" class="px-6 py-3 rounded font-semibold transition-all hover:opacity-90" style="background-color: #7ed321; color: #1a1a1a; box-shadow: 0 4px 12px rgba(126, 211, 33, 0.3);">Crop & Use Image</button>
      </div>
    </div>
  </div>

  <script>
    let cropper = null;
    let currentImageBlob = null;
    const imageInput = document.getElementById('imageInput');
    const cropImage = document.getElementById('cropImage');
    const cropBtn = document.getElementById('cropBtn');
    const extractTextBtn = document.getElementById('extractText');
    const extractedTextPreview = document.getElementById('extractedTextPreview');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const fieldTitle = document.getElementById('fieldTitle');
    const fieldWhat = document.getElementById('fieldWhat');
    const fieldWhen = document.getElementById('fieldWhen');
    const fieldWhere = document.getElementById('fieldWhere');
    const fieldWhy = document.getElementById('fieldWhy');
    const fieldDatePosted = document.getElementById('fieldDatePosted');
    const statusMsg = document.getElementById('statusMsg');

    imageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          cropImage.src = e.target.result;
          document.getElementById('cropModal').style.display = 'flex';
          if (cropper) cropper.destroy();
          cropper = new Cropper(cropImage, {
            viewMode: 1,
            autoCropArea: 1,
            movable: true,
            zoomable: true,
            rotatable: true,
            scalable: true,
            background: false,
            minCropBoxWidth: 100,
            minCropBoxHeight: 100,
          });
          extractTextBtn.disabled = true;
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById('cancelCropBtn').addEventListener('click', () => {
      document.getElementById('cropModal').style.display = 'none';
      if (cropper) cropper.destroy();
      imageInput.value = '';
    });

    cropBtn.addEventListener('click', () => {
      if (cropper) {
        cropper.getCroppedCanvas().toBlob(blob => {
          currentImageBlob = blob;
          document.getElementById('cropModal').style.display = 'none';
          statusMsg.innerHTML = "✓ Image cropped. Now you can run OCR.";
          statusMsg.classList.remove('hidden');
          extractTextBtn.disabled = false;
          if (cropper) cropper.destroy();
        });
      }
    });

    extractTextBtn.addEventListener('click', async () => {
      if (!currentImageBlob) {
        statusMsg.innerHTML = "⚠ Please crop and confirm the image to use for OCR.";
        statusMsg.classList.remove('hidden');
        return;
      }
      statusMsg.classList.add('hidden');
      progressBar.style.width = "0%";
      progressContainer.classList.remove('hidden');
      extractTextBtn.disabled = true;
      extractTextBtn.textContent = 'Recognizing...';
      try {
        const result = await Tesseract.recognize(currentImageBlob, 'eng', {
          logger: m => {
            if (m.status === 'recognizing text') {
              const progress = Math.round(m.progress * 100);
              progressBar.style.width = progress + '%';
              progressText.textContent = `OCR ${progress}%`;
            }
          }
        });
        const extractedText = result.data.text.trim();
        extractedTextPreview.textContent = extractedText || "No text found";
        statusMsg.innerHTML = "⏳ Loading text for structured details...";
        statusMsg.classList.remove('hidden');

        // Call Groq for structured fields:
        const fields = await extractSmartFieldsWithGroq(extractedText);
        
        if (fields && (fields.title || fields.what || fields.when || fields.where || fields.why)) {
          statusMsg.innerHTML = "✓ Fields autofilled!";
          statusMsg.classList.remove('hidden');
        } else {
          statusMsg.innerHTML = "⚠ unable to extract fields.";
          statusMsg.classList.remove('hidden');
        }
        
        fieldTitle.value = fields.title || "";
        fieldWhat.value = fields.what || "";
        fieldWhen.value = fields.when || "";
        fieldWhere.value = fields.where || "";
        fieldWhy.value = fields.why || "";
        fieldDatePosted.value = fields.date_posted || "";

      } catch (err) {
        statusMsg.innerHTML = "❌ ERROR: " + err;
        statusMsg.classList.remove('hidden');
      } finally {
        extractTextBtn.disabled = false;
        extractTextBtn.textContent = 'Extract Text from Image';
        progressContainer.classList.add('hidden');
      }
    });

    // --- GROQ STRUCTURED OUTPUT FUNCTION ---
    async function extractSmartFieldsWithGroq(ocrText) {
      const api_key = "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";
      const prompt = `
Given this text from an announcement or event poster:
"""${ocrText}"""

Extract and return ONLY a JSON object with these keys:
- title: A concise, catchy title for the announcement or event (5-10 words max). This should capture the essence of the event.
- what: A complete, clear, self-contained summary of the main event or announcement (2-3 sentences minimum). Include the core information, what is being announced, and any key details or requests.
- when: The date and time of the event (if specified). Include both date and time if available.
- where: The full location, venue, or institution where the event takes place.
- why: The purpose, reason, or objective of the event or announcement. Why is this happening? What is the goal or benefit?
- date_posted: The actual posting date or publication date (if found in the text).

Important:
- Return ONLY valid JSON, no markdown, no explanation, no extra text.
- If a field is not found, use an empty string "".
- Be comprehensive in the "what" and "why" fields.
- Make the title engaging and informative.

Example format:
{
  "title": "...",
  "what": "...",
  "when": "...",
  "where": "...",
  "why": "...",
  "date_posted": "..."
}
`;

      const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${api_key}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: "llama-3.3-70b-versatile",
          messages: [
            { role: "system", content: "You extract only JSON." },
            { role: "user", content: prompt }
          ],
          max_tokens: 256,
          temperature: 0.1,
        }),
      });
      const data = await response.json();
      try {
        const match = data.choices[0].message.content.match(/\{[\s\S]*\}/);
        if (match) return JSON.parse(match[0]);
        return {};
      } catch {
        return {};
      }
    }
  </script>
</body>
</html>

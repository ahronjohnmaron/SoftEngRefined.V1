<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Announcement</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { 
          font-family: 'Poppins', sans-serif;
          background-color: #1a1a1a;
        }
        .card-shadow {
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        .input-shadow {
          box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .cropper-modal {
          background-color: rgba(0, 0, 0, 0.2) !important;
        }
        .cropper-crop-box {
          border: 3px solid #7ed321 !important;
          box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.2) !important;
        }
        .cropper-view-box {
          outline: 3px solid #7ed321 !important;
        }
        .crop-modal {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(26, 26, 26, 0.95);
          display: none;
          align-items: center;
          justify-content: center;
          z-index: 9999;
        }
        .crop-modal-content {
          background: #2d2d2d;
          border-radius: 8px;
          padding: 30px;
          max-width: 90vw;
          max-height: 90vh;
          overflow: auto;
        }
        .error-badge {
          background-color: rgba(239, 68, 68, 0.1);
          border: 1px solid rgba(239, 68, 68, 0.3);
          color: #ef4444;
        }
        .success-badge {
          background-color: rgba(126, 211, 33, 0.1);
          border: 1px solid rgba(126, 211, 33, 0.3);
          color: #7ed321;
        }
        .warning-badge {
          background-color: rgba(251, 191, 36, 0.1);
          border: 1px solid rgba(251, 191, 36, 0.3);
          color: #fbbf24;
        }
    </style>
</head>
<body class="text-white min-h-screen p-6">
  <div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-8">
        <a href="faculty_Dashboard.html" class="inline-flex items-center gap-2 text-lg font-semibold transition-all opacity-90 hover:opacity-100" style="color: #7ed321;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
            </svg>
            Back to Dashboard
        </a>
        <h1 class="text-3xl font-bold text-center" style="color: #7ed321;">Upload Announcement</h1>
        <div style="width: 180px;"></div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="space-y-6">
        <div class="rounded-lg p-6 card-shadow" style="background-color: #2d2d2d;">
          <label for="imageInput" class="block font-semibold mb-3 text-lg" style="color: #7ed321;">Upload or Capture Image</label>
          <input type="file" id="imageInput" accept="image/*" class="mb-4 w-full text-sm rounded border px-3 py-2 text-white input-shadow" style="background-color: #1a1a1a; border-color: #3d3d3d;">
          
          <div class="flex gap-3 mb-4">
            <button id="captureBtn" class="flex-1 px-4 py-3 rounded font-bold transition-all hover:opacity-90" style="background-color: #3d3d3d; color: #ffffff;">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="inline-block mr-2 mb-1" viewBox="0 0 16 16">
                <path d="M15 12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1.172a3 3 0 0 0 2.12-.879l.83-.828A1 1 0 0 1 6.827 3h2.344a1 1 0 0 1 .707.293l.828.828A3 3 0 0 0 12.828 5H14a1 1 0 0 1 1 1v6zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4H2z"/>
                <path d="M8 11a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5zm0 1a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7zM3 6.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0z"/>
              </svg>
              Capture Photo
            </button>
          </div>
          
          <div class="flex gap-3">
            <button id="extractText" class="flex-1 px-4 py-3 rounded font-bold disabled:opacity-50 transition-all hover:opacity-90" style="background-color: #7ed321; color: #1a1a1a; box-shadow: 0 4px 12px rgba(126, 211, 33, 0.3);" disabled>Extract Text</button>
          </div>
          
          <div id="progressContainer" class="mt-4 hidden">
            <div class="h-3 rounded-full overflow-hidden mb-2" style="background-color: #3d3d3d; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);">
              <div class="h-3 w-0 transition-all" id="progressBar" style="background-color: #7ed321;"></div>
            </div>
            <div class="font-semibold text-sm text-center" id="progressText" aria-live="polite" style="color: #7ed321;">Starting OCR...</div>
          </div>
        </div>
        
        <div class="rounded-lg p-6 card-shadow" style="background-color: #2d2d2d; min-height: 600px;">
          <div class="font-bold mb-3 text-xl" style="color: #7ed321;">Extracted Text Preview</div>
          <pre id="extractedTextPreview" class="rounded p-4 break-all text-base input-shadow overflow-auto" style="background-color: #1a1a1a; color: #a0a0a0; min-height: 520px;">No text extracted yet</pre>
        </div>
      </div>
      
      <div>
        <form id="announcementForm" class="rounded-lg p-8 space-y-6 card-shadow" style="background-color: #2d2d2d; min-height: 800px;">
          <div class="text-2xl font-bold mb-6" style="color: #7ed321;">Announcement Details</div>
          
          <div class="grid grid-cols-1 gap-4">
            <div>
                <label class="block mb-2 font-semibold text-base" for="fieldTitle" style="color: #7ed321;">Title *</label>
                <input id="fieldTitle" class="w-full rounded px-4 py-3 text-white text-base input-shadow" style="background-color: #1a1a1a; border: 1px solid #3d3d3d;" autocomplete="off" placeholder="Main title of the announcement" required />
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="category" class="block mb-2 font-semibold text-base" style="color: #7ed321;">Category *</label>
                    <select id="category" required class="w-full rounded px-4 py-3 text-white text-base input-shadow cursor-pointer" style="background-color: #1a1a1a; border: 1px solid #3d3d3d; appearance: none;">
                        <option value="">Select Category</option>
                        <option value="Emergency">Emergency</option>
                        <option value="Memo">Memo</option>
                        <option value="Notices">Notices</option>
                        <option value="Deadline">Deadline</option>
                    </select>
                </div>
                <div>
                    <label for="targetAudience" class="block mb-2 font-semibold text-base" style="color: #7ed321;">Target Audience *</label>
                    <select id="targetAudience" required class="w-full rounded px-4 py-3 text-white text-base input-shadow cursor-pointer" style="background-color: #1a1a1a; border: 1px solid #3d3d3d; appearance: none;">
                        <option value="">Select Target Audience</option>
                        <option value="all">All</option>
                        <option value="faculty">Faculty Only</option>
                        <option value="students">Students Only</option>
                    </select>
                </div>
            </div>

            <div>
              <label class="block mb-2 font-semibold text-base" for="fieldWhat" style="color: #7ed321;">What (Full Description)</label>
              <textarea id="fieldWhat" class="w-full rounded px-4 py-3 text-white text-base input-shadow" style="background-color: #1a1a1a; border: 1px solid #3d3d3d; height: 180px; resize: vertical;" placeholder="Complete announcement content"></textarea>
            </div>

            <!-- NEW SUMMARY FIELD -->
            <div>
              <label class="block mb-2 font-semibold text-base" for="fieldSummary" style="color: #7ed321;">Summary (Brief Overview)</label>
              <textarea id="fieldSummary" class="w-full rounded px-4 py-3 text-white text-base input-shadow" style="background-color: #1a1a1a; border: 1px solid #3d3d3d; height: 120px; resize: vertical;" placeholder="Auto-generated concise summary"></textarea>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block mb-2 font-semibold text-base" for="fieldWhen" style="color: #7ed321;">When (Scheduled Date)</label>
                <input id="fieldWhen" type="date" class="w-full rounded px-4 py-3 text-white text-base input-shadow" style="background-color: #1a1a1a; border: 1px solid #3d3d3d;" autocomplete="off" placeholder="Event date and time" />
              </div>
              
              <div>
                <label class="block mb-2 font-semibold text-base" for="fieldWhere" style="color: #7ed321;">Where (Location)</label>
                <input id="fieldWhere" class="w-full rounded px-4 py-3 text-white text-base input-shadow" style="background-color: #1a1a1a; border: 1px solid #3d3d3d;" autocomplete="off" placeholder="Event location or venue" />
              </div>
            </div>
            
            <div>
              <label class="block mb-2 font-semibold text-base" for="fieldWhy" style="color: #7ed321;">Why (Purpose)</label>
              <textarea id="fieldWhy" class="w-full rounded px-4 py-3 text-white text-base input-shadow" style="background-color: #1a1a1a; border: 1px solid #3d3d3d; height: 150px; resize: vertical;" placeholder="Purpose or reason for the event"></textarea>
            </div>
            
            <div>
              <label class="block mb-2 font-semibold text-base" for="fieldDatePosted" style="color: #7ed321;">Date Posted</label>
              <input id="fieldDatePosted" class="w-full rounded px-4 py-3 text-base input-shadow" style="background-color: #1a1a1a; border: 1px solid #3d3d3d; color: #7a7a7a;" readonly />
            </div>
          </div>
          
          <div id="statusMsg" class="text-base mt-6 font-semibold text-center p-4 rounded hidden"></div>

          <button type="submit" id="saveButton" class="w-full px-4 py-3 rounded font-bold transition-all hover:opacity-90 mt-6" style="background-color: #7ed321; color: #1a1a1a; box-shadow: 0 4px 12px rgba(126, 211, 33, 0.3);">
            Save Announcement
          </button>
        </form>
      </div>
    </div>
  </div>

  <div id="cameraModal" class="crop-modal">
    <div class="crop-modal-content card-shadow">
      <h2 class="text-2xl font-bold mb-4" style="color: #7ed321;">Capture Announcement Photo</h2>
      <div class="mb-4 relative">
        <video id="cameraVideo" autoplay playsinline class="rounded w-full mx-auto" style="border: 2px solid #7ed321; max-height: 60vh; background: #000;"></video>
        <canvas id="cameraCanvas" class="hidden"></canvas>
      </div>
      <div class="flex gap-3 justify-end">
        <button id="cancelCameraBtn" class="px-6 py-3 rounded font-semibold transition-all hover:opacity-90" style="background-color: #3d3d3d; color: #ffffff;">Cancel</button>
        <button id="capturePhotoBtn" class="px-6 py-3 rounded font-semibold transition-all hover:opacity-90" style="background-color: #7ed321; color: #1a1a1a; box-shadow: 0 4px 12px rgba(126, 211, 33, 0.3);">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="inline-block mr-2 mb-1" viewBox="0 0 16 16">
            <path d="M10.5 8.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>
            <path d="M2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4H2zm.5 2a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1zm9 2.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0z"/>
          </svg>
          Take Photo
        </button>
      </div>
    </div>
  </div>

  <div id="cropModal" class="crop-modal">
    <div class="crop-modal-content card-shadow">
      <h2 class="text-2xl font-bold mb-4" style="color: #7ed321;">Crop Your Image</h2>
      <div class="mb-4">
        <img id="cropImage" class="rounded w-full mx-auto" style="border: 2px solid #7ed321; max-height: 70vh;" />
      </div>
      <div class="flex gap-3 justify-end">
        <button id="cancelCropBtn" class="px-6 py-3 rounded font-semibold transition-all hover:opacity-90" style="background-color: #3d3d3d; color: #ffffff;">Cancel</button>
        <button id="cropBtn" class="px-6 py-3 rounded font-semibold transition-all hover:opacity-90" style="background-color: #7ed321; color: #1a1a1a; box-shadow: 0 4px 12px rgba(126, 211, 33, 0.3);">Crop & Use Image</button>
      </div>
    </div>
  </div>

  <script>
    // =============================================================================
    // CONFIGURATION & CONSTANTS
    // =============================================================================
    const CONFIG = {
      SUPABASE_URL: 'https://dqtictujkhxultwoaqaw.supabase.co',
      SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxdGljdHVqa2h4dWx0d29hcWF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyOTU1MjksImV4cCI6MjA3Mzg3MTUyOX0.DsnJZ9ylCBlTeVp_KdgRq71cV0f7MojOfuWg1MVGS5I',
      GROQ_API_KEY: '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',
      GROQ_MODEL: 'llama-3.1-8b-instant',
      MAX_RETRIES: 3,
      RETRY_DELAY: 2000,
      REQUEST_TIMEOUT: 30000,
      MIN_OCR_TEXT_LENGTH: 10
    };

    const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

    // =============================================================================
    // GLOBAL STATE
    // =============================================================================
    let cropper = null;
    let currentImageBlob = null;
    let currentUserProfile = null;
    let cameraStream = null;

    // =============================================================================
    // DOM ELEMENTS
    // =============================================================================
    const imageInput = document.getElementById('imageInput');
    const cropImage = document.getElementById('cropImage');
    const cropBtn = document.getElementById('cropBtn');
    const extractTextBtn = document.getElementById('extractText');
    const extractedTextPreview = document.getElementById('extractedTextPreview');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const statusMsg = document.getElementById('statusMsg');
    
    // Camera elements
    const captureBtn = document.getElementById('captureBtn');
    const cameraModal = document.getElementById('cameraModal');
    const cameraVideo = document.getElementById('cameraVideo');
    const cameraCanvas = document.getElementById('cameraCanvas');
    const capturePhotoBtn = document.getElementById('capturePhotoBtn');
    const cancelCameraBtn = document.getElementById('cancelCameraBtn');
    
    const announcementForm = document.getElementById('announcementForm');
    const fieldTitle = document.getElementById('fieldTitle');
    const fieldCategory = document.getElementById('category');
    const fieldTargetAudience = document.getElementById('targetAudience');
    const fieldWhat = document.getElementById('fieldWhat');
    const fieldSummary = document.getElementById('fieldSummary'); // NEW
    const fieldWhen = document.getElementById('fieldWhen');
    const fieldWhere = document.getElementById('fieldWhere');
    const fieldWhy = document.getElementById('fieldWhy');
    const fieldDatePosted = document.getElementById('fieldDatePosted');
    const saveButton = document.getElementById('saveButton');

    // =============================================================================
    // CUSTOM ERROR CLASSES
    // =============================================================================
    class OCRError extends Error {
      constructor(message, originalError = null) {
        super(message);
        this.name = 'OCRError';
        this.originalError = originalError;
        this.timestamp = new Date().toISOString();
      }
    }

    class GroqAPIError extends Error {
      constructor(message, statusCode = null, originalError = null) {
        super(message);
        this.name = 'GroqAPIError';
        this.statusCode = statusCode;
        this.originalError = originalError;
        this.timestamp = new Date().toISOString();
      }
    }

    class ValidationError extends Error {
      constructor(message, field = null) {
        super(message);
        this.name = 'ValidationError';
        this.field = field;
        this.timestamp = new Date().toISOString();
      }
    }

    // =============================================================================
    // UTILITY FUNCTIONS
    // =============================================================================
    
    function showStatus(message, type = 'info') {
      statusMsg.textContent = message;
      statusMsg.className = 'text-base mt-6 font-semibold text-center p-4 rounded';
      
      if (type === 'error') {
        statusMsg.classList.add('error-badge');
      } else if (type === 'success') {
        statusMsg.classList.add('success-badge');
      } else if (type === 'warning') {
        statusMsg.classList.add('warning-badge');
      } else {
        statusMsg.classList.add('success-badge');
      }
      
      statusMsg.classList.remove('hidden');
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function getBackoffDelay(attempt) {
      return Math.min(CONFIG.RETRY_DELAY * Math.pow(2, attempt), 10000);
    }

    function getTodayDate() {
      const today = new Date();
      const year = today.getFullYear();
      const month = (today.getMonth() + 1).toString().padStart(2, '0');
      const day = today.getDate().toString().padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function validateExtractedFields(fields) {
      const errors = [];
      
      const validAudiences = ['all', 'faculty', 'students'];
      if (fields.target_audience && !validAudiences.includes(fields.target_audience)) {
        errors.push(`Invalid target_audience: "${fields.target_audience}". Defaulting to "all".`);
        fields.target_audience = 'all';
      }
      
      const validCategories = ['Emergency', 'Memo', 'Notices', 'Deadline'];
      if (fields.category && !validCategories.includes(fields.category)) {
        errors.push(`Invalid category: "${fields.category}". Defaulting to "Notices".`);
        fields.category = 'Notices';
      }
      
      if (fields.when && fields.when !== '') {
        const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
        if (!dateRegex.test(fields.when)) {
          errors.push(`Invalid date format: "${fields.when}". Clearing date field.`);
          fields.when = '';
        }
      }
      
      if (fields.title && fields.title.length > 100) {
        errors.push(`Title too long (${fields.title.length} chars). Truncating to 100 characters.`);
        fields.title = fields.title.substring(0, 100);
      }
      
      return { isValid: errors.length === 0, errors, fields };
    }

    function sanitizeForJSON(str) {
      if (!str) return '';
      return str
        .replace(/\\/g, '\\\\')
        .replace(/"/g, '\\"')
        .replace(/\n/g, ' ')
        .replace(/\r/g, ' ')
        .replace(/\t/g, ' ')
        .trim();
    }

    // =============================================================================
    // PAGE INITIALIZATION
    // =============================================================================
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        if (!protectPage()) {
          throw new Error("Authentication required");
        }
        await loadUserProfile();
        setTodayDate();
        console.log('‚úÖ Page initialized successfully');
      } catch (error) {
        console.error('‚ùå Initialization error:', error);
        showStatus('Failed to initialize page. Please refresh.', 'error');
      }
    });

    function protectPage() {
      const loggedInUser = localStorage.getItem('loggedInUser');
      if (!loggedInUser) {
        console.log('üîí No session - redirecting to login');
        window.location.href = 'faculty_login.html';
        return false;
      }
      return true;
    }

    async function loadUserProfile() {
      const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
      if (!loggedInUser?.email) {
        throw new Error('No user email found in session');
      }

      try {
        const { data, error } = await supabaseClient
          .from('members')
          .select('id, full_name, avatar_url, email, user_type')
          .eq('email', loggedInUser.email)
          .single();
        
        if (error) throw error;
        
        currentUserProfile = data;
        console.log('‚úÖ User profile loaded:', currentUserProfile.id);
      } catch (error) {
        console.error('‚ùå Error fetching user profile:', error);
        throw new Error('Failed to load user profile');
      }
    }

    function setTodayDate() {
      fieldDatePosted.value = getTodayDate();
    }

    // =============================================================================
    // IMAGE CROPPING LOGIC
    // =============================================================================
    
    imageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      if (!file.type.startsWith('image/')) {
        showStatus('Please select a valid image file', 'error');
        return;
      }
      
      if (file.size > 10 * 1024 * 1024) {
        showStatus('Image file too large. Maximum size is 10MB.', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        cropImage.src = e.target.result;
        document.getElementById('cropModal').style.display = 'flex';
        if (cropper) cropper.destroy();
        cropper = new Cropper(cropImage, {
          viewMode: 1,
          autoCropArea: 1,
          movable: true,
          zoomable: true,
          rotatable: true,
          scalable: true,
          background: false,
          minCropBoxWidth: 100,
          minCropBoxHeight: 100,
        });
        extractTextBtn.disabled = true;
      };
      reader.onerror = () => {
        showStatus('Failed to read image file', 'error');
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('cancelCropBtn').addEventListener('click', () => {
      document.getElementById('cropModal').style.display = 'none';
      if (cropper) cropper.destroy();
      imageInput.value = '';
    });

    cropBtn.addEventListener('click', () => {
      if (cropper) {
        cropper.getCroppedCanvas().toBlob(blob => {
          currentImageBlob = blob;
          document.getElementById('cropModal').style.display = 'none';
          showStatus('‚úì Image cropped. Ready for OCR extraction.', 'success');
          extractTextBtn.disabled = false;
          if (cropper) cropper.destroy();
        });
      }
    });

    // =============================================================================
    // CAMERA CAPTURE FUNCTIONALITY
    // =============================================================================
    
    captureBtn.addEventListener('click', async () => {
      try {
        cameraModal.style.display = 'flex';
        
        const constraints = {
          video: {
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        };
        
        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
        cameraVideo.srcObject = cameraStream;
        
        console.log('‚úÖ Camera started successfully');
      } catch (error) {
        console.error('‚ùå Camera access error:', error);
        cameraModal.style.display = 'none';
        
        if (error.name === 'NotAllowedError') {
          showStatus('Camera access denied. Please allow camera permissions.', 'error');
        } else if (error.name === 'NotFoundError') {
          showStatus('No camera found on this device.', 'error');
        } else {
          showStatus('Failed to access camera: ' + error.message, 'error');
        }
      }
    });

    capturePhotoBtn.addEventListener('click', () => {
      if (!cameraStream) {
        showStatus('Camera not ready. Please try again.', 'error');
        return;
      }
      
      const video = cameraVideo;
      const canvas = cameraCanvas;
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      canvas.toBlob(blob => {
        stopCamera();
        cameraModal.style.display = 'none';
        
        const reader = new FileReader();
        reader.onload = (e) => {
          cropImage.src = e.target.result;
          document.getElementById('cropModal').style.display = 'flex';
          
          if (cropper) cropper.destroy();
          cropper = new Cropper(cropImage, {
            viewMode: 1,
            autoCropArea: 1,
            movable: true,
            zoomable: true,
            rotatable: true,
            scalable: true,
            background: false,
            minCropBoxWidth: 100,
            minCropBoxHeight: 100,
          });
          
          extractTextBtn.disabled = true;
          showStatus('‚úì Photo captured. Crop the announcement area.', 'success');
        };
        reader.readAsDataURL(blob);
      }, 'image/jpeg', 0.95);
    });

    cancelCameraBtn.addEventListener('click', () => {
      stopCamera();
      cameraModal.style.display = 'none';
    });

    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
        cameraVideo.srcObject = null;
        console.log('‚úÖ Camera stopped');
      }
    }

    // =============================================================================
    // OCR TEXT EXTRACTION WITH ERROR HANDLING
    // =============================================================================
    
    extractTextBtn.addEventListener('click', async () => {
      if (!currentImageBlob) {
        showStatus('‚ö† Please crop and confirm the image first.', 'warning');
        return;
      }

      statusMsg.classList.add('hidden');
      progressBar.style.width = '0%';
      progressContainer.classList.remove('hidden');
      extractTextBtn.disabled = true;
      extractTextBtn.textContent = 'Recognizing...';

      try {
        const ocrText = await performOCR(currentImageBlob);
        
        if (!ocrText || ocrText.length < CONFIG.MIN_OCR_TEXT_LENGTH) {
          throw new OCRError('Insufficient text extracted from image. Please try a clearer image.');
        }

        extractedTextPreview.textContent = ocrText;
        showStatus('‚è≥ Extracting structured data with AI...', 'info');

        const fields = await extractFieldsWithRetry(ocrText);
        
        const validation = validateExtractedFields(fields);
        
        if (!validation.isValid) {
          console.warn('‚ö† Validation warnings:', validation.errors);
          showStatus(`‚ö† Fields extracted with ${validation.errors.length} warning(s). Please review.`, 'warning');
        } else {
          showStatus('‚úÖ All fields extracted successfully!', 'success');
        }
        
        populateFormFields(validation.fields);

      } catch (error) {
        handleExtractionError(error);
      } finally {
        extractTextBtn.disabled = false;
        extractTextBtn.textContent = 'Extract Text from Image';
        progressContainer.classList.add('hidden');
      }
    });

    async function performOCR(imageBlob) {
      try {
        const result = await Tesseract.recognize(imageBlob, 'eng', {
          logger: m => {
            if (m.status === 'recognizing text') {
              const progress = Math.round(m.progress * 100);
              progressBar.style.width = progress + '%';
              progressText.textContent = `OCR ${progress}%`;
            }
          }
        });
        
        const text = result.data.text.trim();
        console.log('‚úÖ OCR completed. Text length:', text.length);
        return text;
        
      } catch (error) {
        throw new OCRError('OCR recognition failed', error);
      }
    }

    // =============================================================================
    // GROQ API INTEGRATION WITH RETRY LOGIC
    // =============================================================================

    async function extractFieldsWithRetry(ocrText) {
      let lastError = null;
      
      for (let attempt = 0; attempt < CONFIG.MAX_RETRIES; attempt++) {
        try {
          console.log(`üîÑ Groq API attempt ${attempt + 1}/${CONFIG.MAX_RETRIES}`);
          
          const fields = await extractSmartFieldsWithGroq(ocrText);
          
          if (!fields || typeof fields !== 'object') {
            throw new GroqAPIError('Invalid response format from API');
          }
          
          console.log('‚úÖ Groq extraction successful:', fields);
          return fields;
          
        } catch (error) {
          lastError = error;
          console.warn(`‚ö† Attempt ${attempt + 1} failed:`, error.message);
          
          if (error instanceof ValidationError) {
            throw error;
          }
          
          if (attempt < CONFIG.MAX_RETRIES - 1) {
            const delay = getBackoffDelay(attempt);
            console.log(`‚è≥ Retrying in ${delay}ms...`);
            showStatus(`Attempt ${attempt + 1} failed. Retrying...`, 'warning');
            await sleep(delay);
          }
        }
      }
      
      throw new GroqAPIError(
        `Failed after ${CONFIG.MAX_RETRIES} attempts: ${lastError.message}`,
        null,
        lastError
      );
    }

    /**
     * MODIFIED: Now extracts 8 fields including "summary"
     */
    async function extractSmartFieldsWithGroq(ocrText) {
      const prompt = `# TASK: Extract structured data from OCR announcement text

**INPUT TEXT:**
"""
${sanitizeForJSON(ocrText)}
"""

**ANCHOR DATE:** November 9, 2025

## EXTRACTION RULES

### 1. TITLE (5-10 words)
Extract headline or synthesize from main topic. Never empty.

### 2. WHAT (100% VERBATIM - MOST CRITICAL)
**COPY THE ENTIRE ANNOUNCEMENT TEXT EXACTLY AS IT APPEARS**
- Include EVERY SINGLE SENTENCE from the original text
- Include EVERY PARAGRAPH without exception
- Only fix obvious OCR character errors: l‚ÜíI, 0‚ÜíO, rn‚Üím, "Novemher"‚Üí"November", "20Z5"‚Üí"2025"
- DO NOT rephrase, summarize, condense, or skip ANY content
- DO NOT remove any details, instructions, requirements, dates, times, contact information
- Replace newlines with single spaces but preserve ALL text
- This field MUST contain 95-100% of the original OCR text length

**ABSOLUTE RULE: If announcement has 15 sentences, extract all 15. If it has 200 words, extract 190-200 words. PASTE EVERYTHING.**

### 3. SUMMARY (NEW - 2-3 sentences)
**Create a CONCISE SUMMARY of the announcement**
- Abstractive summarization: condense the main message
- Include: key action/event, date if important, audience if specific
- 2-3 sentences maximum (40-60 words)
- Make it informative but brief - suitable for notifications/previews
- Example: "Students must submit final project proposals by November 15th. Late submissions will not be accepted. Contact IT helpdesk for technical assistance."

### 4. WHEN (YYYY-MM-DD or "")
Smart date extraction:
- Parse: "Nov 9", "11/09/2025", "November 9th", "9-11-2025"
- If only month/day ‚Üí use 2025 as year
- Relative: "tomorrow"‚Üí2025-11-10, "next Monday"‚Üícalculate from Nov 9
- Return "" if no date found

### 5. WHERE
Complete location: rooms, buildings, addresses, online platforms, venues.
Return "" only if no location at all.

### 6. WHY
Purpose in 1-2 sentences. Extract or intelligently infer from context. Never empty.

### 7. TARGET_AUDIENCE (enum)
IF "all/everyone" OR (students AND faculty) OR no_specific_audience ‚Üí "all"
ELSE IF only_students ‚Üí "students"
ELSE IF only_faculty ‚Üí "faculty"
DEFAULT ‚Üí "all"

### 8. CATEGORY (enum - priority)
Emergency (urgent/cancelled) > Deadline (due/submit) > Memo (directive/policy) > Notices (default)

## OUTPUT JSON (no markdown, no explanations):
{
  "title": "string",
  "what": "COMPLETE VERBATIM announcement text with only OCR fixes",
  "summary": "2-3 sentence concise summary",
  "when": "YYYY-MM-DD or empty",
  "where": "string or empty",
  "why": "string",
  "target_audience": "all|faculty|students",
  "category": "Emergency|Memo|Notices|Deadline"
}`;

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), CONFIG.REQUEST_TIMEOUT);

      try {
        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${CONFIG.GROQ_API_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: CONFIG.GROQ_MODEL,
            messages: [
              {
                role: "system",
                content: "You are an NLP extraction specialist. For 'what' field: copy ENTIRE text verbatim with only OCR fixes. For 'summary' field: create a brief 2-3 sentence abstractive summary. For other fields: use intelligent prediction. Return ONLY valid JSON."
              },
              {
                role: "user",
                content: prompt
              }
            ],
            temperature: 0.05,
            max_tokens: 2000,
            response_format: { type: "json_object" }
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new GroqAPIError(
            `API request failed: ${response.statusText}`,
            response.status
          );
        }

        const data = await response.json();

        if (data.error) {
          throw new GroqAPIError(`API error: ${data.error.message}`);
        }

        if (!data.choices || data.choices.length === 0) {
          throw new GroqAPIError('No response from API');
        }

        let content = data.choices[0].message.content.trim();

        content = content.replace(/``````\n?/g, '');

        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          content = jsonMatch[0];
        }

        const parsed = JSON.parse(content);

        const requiredFields = ['title', 'what', 'summary', 'when', 'where', 'why', 'target_audience', 'category'];
        for (const field of requiredFields) {
          if (!(field in parsed)) {
            console.warn(`‚ö† Missing field "${field}", using default`);
            parsed[field] = getDefaultValue(field);
          }
        }

        // Quality check for "what" field verbatim requirement
        if (parsed.what && parsed.what.length < ocrText.length * 0.7) {
          console.warn(`‚ö† WARNING: "what" field only ${Math.round(parsed.what.length / ocrText.length * 100)}% of original. Expected 95%+`);
        }

        return parsed;

      } catch (error) {
        if (error.name === 'AbortError') {
          throw new GroqAPIError('Request timeout exceeded', 408);
        }
        if (error instanceof GroqAPIError) {
          throw error;
        }
        if (error instanceof SyntaxError) {
          throw new GroqAPIError('Invalid JSON response from API', null, error);
        }
        throw new GroqAPIError('Unexpected error during API call', null, error);
      } finally {
        clearTimeout(timeoutId);
      }
    }

    function getDefaultValue(field) {
      const defaults = {
        title: '',
        what: '',
        summary: '', // NEW
        when: '',
        where: '',
        why: '',
        target_audience: 'all',
        category: 'Notices'
      };
      return defaults[field] || '';
    }

    function populateFormFields(fields) {
      fieldTitle.value = fields.title || '';
      fieldCategory.value = fields.category || '';
      fieldTargetAudience.value = fields.target_audience || '';
      fieldWhat.value = fields.what || '';
      fieldSummary.value = fields.summary || ''; // NEW
      fieldWhen.value = fields.when || '';
      fieldWhere.value = fields.where || '';
      fieldWhy.value = fields.why || '';
      setTodayDate();
    }

    function handleExtractionError(error) {
      console.error('‚ùå Extraction error:', error);

      if (error instanceof OCRError) {
        showStatus(`OCR Error: ${error.message}`, 'error');
      } else if (error instanceof GroqAPIError) {
        showStatus(`AI Extraction Error: ${error.message}`, 'error');
      } else if (error instanceof ValidationError) {
        showStatus(`Validation Error: ${error.message}`, 'error');
      } else {
        showStatus(`Unexpected error: ${error.message}`, 'error');
      }

      console.error('Full error details:', {
        name: error.name,
        message: error.message,
        stack: error.stack,
        timestamp: error.timestamp || new Date().toISOString()
      });
    }

    // =============================================================================
    // SAVE TO SUPABASE
    // =============================================================================

    announcementForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      await saveAnnouncement();
    });

    async function saveAnnouncement() {
      try {
        if (!currentUserProfile) {
          throw new ValidationError('User profile not loaded. Please refresh the page.');
        }

        const announcementData = {
          title: fieldTitle.value.trim(),
          category: fieldCategory.value,
          target_audience: fieldTargetAudience.value,
          description: fieldWhat.value.trim() || null,
          summary: fieldSummary.value.trim() || null, // NEW - stores in "summary" column
          scheduled_date: fieldWhen.value || null,
          location: fieldWhere.value.trim() || null,
          why: fieldWhy.value.trim() || null,
          posted_at: getTodayDate(),
          posted_by: currentUserProfile.full_name || 'Unknown User',
          posted_by_user_id: currentUserProfile.id
        };

        if (!announcementData.title) {
          throw new ValidationError('Title is required', 'title');
        }
        if (!announcementData.category) {
          throw new ValidationError('Category is required', 'category');
        }
        if (!announcementData.target_audience) {
          throw new ValidationError('Target Audience is required', 'target_audience');
        }

        saveButton.disabled = true;
        saveButton.textContent = 'Saving...';
        showStatus('‚è≥ Saving announcement to database...', 'info');

        const { error } = await supabaseClient
          .from('announcements')
          .insert([announcementData]);

        if (error) throw error;

        showStatus('‚úÖ Announcement saved successfully!', 'success');
        
        announcementForm.reset();
        setTodayDate();
        extractedTextPreview.textContent = 'No text extracted yet';
        imageInput.value = '';
        currentImageBlob = null;

        console.log('‚úÖ Announcement saved:', announcementData);

      } catch (error) {
        console.error('‚ùå Save error:', error);
        
        if (error instanceof ValidationError) {
          showStatus(`Validation Error: ${error.message}`, 'error');
          if (error.field) {
            const field = document.getElementById(`field${error.field.charAt(0).toUpperCase() + error.field.slice(1)}`);
            if (field) field.focus();
          }
        } else {
          showStatus(`Save Error: ${error.message}`, 'error');
        }
      } finally {
        saveButton.disabled = false;
        saveButton.textContent = 'Save Announcement';
      }
    }

    // =============================================================================
    // GLOBAL ERROR HANDLER
    // =============================================================================
    
    window.addEventListener('unhandledrejection', (event) => {
      console.error('‚ùå Unhandled promise rejection:', event.reason);
      showStatus('An unexpected error occurred. Please try again.', 'error');
    });

    window.addEventListener('error', (event) => {
      console.error('‚ùå Global error:', event.error);
    });

  </script>
</body>
</html>


